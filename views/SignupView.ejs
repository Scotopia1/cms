<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Company - Project Management CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container {
            max-width: 680px; /* Wider for more fields */
        }
        .section-title {
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
            padding-bottom: 0.75rem; /* pb-3 */
            margin-bottom: 1.5rem; /* mb-6 */
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #374151; /* Gray-700 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-700 min-h-screen flex flex-col items-center justify-center py-12 px-4">

<div class="form-container w-full bg-white p-8 sm:p-10 rounded-xl shadow-2xl">
    <div class="text-center mb-8">
        <i class="fas fa-building text-5xl text-purple-600 mb-3"></i>
        <h1 class="text-3xl font-bold text-gray-800">Register Your Company</h1>
        <p class="text-gray-600">Join us and start managing your projects efficiently.</p>
    </div>

    <form id="companyRegistrationForm" class="space-y-8">
        <div>
            <h2 class="section-title">Company Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name <span class="text-red-500">*</span></label>
                    <input type="text" id="companyName" name="companyName" placeholder="e.g., Innovatech Ltd." class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" required>
                </div>
                <div>
                    <label for="companyIndustry" class="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                    <input type="text" id="companyIndustry" name="companyIndustry" placeholder="e.g., Technology" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                </div>
                <div>
                    <label for="companyLocation" class="block text-sm font-medium text-gray-700 mb-1">Location / Address</label>
                    <input type="text" id="companyLocation" name="companyLocation" placeholder="e.g., 123 Tech Street, Innovation City" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                </div>
                <div>
                    <label for="companyContact" class="block text-sm font-medium text-gray-700 mb-1">Contact Info (Phone/Email)</label>
                    <input type="text" id="companyContact" name="companyContact" placeholder="e.g., +1-555-1234 / contact@company.com" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                </div>
                <div class="md:col-span-2">
                    <label for="companyWebsite" class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                    <input type="url" id="companyWebsite" name="companyWebsite" placeholder="https://www.yourcompany.com" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                </div>
            </div>
        </div>

        <div>
            <h2 class="section-title">Administrator Account</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div>
                    <label for="adminName" class="block text-sm font-medium text-gray-700 mb-1">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="adminName" name="adminName" placeholder="e.g., Jane Doe" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" required>
                </div>
                <div>
                    <label for="adminPosition" class="block text-sm font-medium text-gray-700 mb-1">Position / Role <span class="text-red-500">*</span></label>
                    <input type="text" id="adminPosition" name="adminPosition" placeholder="e.g., CEO, Project Manager" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" required>
                </div>
                <div>
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address <span class="text-red-500">*</span></label>
                    <input type="email" id="adminEmail" name="adminEmail" placeholder="you@example.com" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" required>
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
                    <input type="password" id="adminPassword" name="adminPassword" placeholder="••••••••" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150" required>
                </div>
            </div>
        </div>

        <div class="pt-2">
            <button type="submit" id="registerButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150">
                <i class="fas fa-user-plus mr-2"></i>Create Account
            </button>
        </div>
    </form>

    <div id="messageBox" class="mt-6 text-center text-sm"></div>

    <p class="mt-8 text-center text-sm text-gray-600">
        Already have an account?
        <a href="../ui/login" class="font-medium text-purple-600 hover:text-purple-500">Sign In</a>
    </p>
</div>

<script>
    const registrationForm = document.getElementById('companyRegistrationForm');
    const registerButton = document.getElementById('registerButton');
    const messageBox = document.getElementById('messageBox');

    registrationForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageBox.textContent = '';
        messageBox.className = 'mt-6 text-center text-sm'; // Reset classes
        registerButton.disabled = true;
        registerButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Account...';

        const companyData = {
            Name: document.getElementById('companyName').value,
            Location: document.getElementById('companyLocation').value,
            ContactInfo: document.getElementById('companyContact').value,
            Industry: document.getElementById('companyIndustry').value,
            Website: document.getElementById('companyWebsite').value,
        };

        const adminUserData = {
            Name: document.getElementById('adminName').value,
            Email: document.getElementById('adminEmail').value,
            Password: document.getElementById('adminPassword').value,
            Position: document.getElementById('adminPosition').value,
        };

        // Basic client-side validation
        if (!companyData.Name || !adminUserData.Name || !adminUserData.Email || !adminUserData.Password || !adminUserData.Position) {
            messageBox.textContent = 'Please fill in all required fields marked with *.';
            messageBox.className += ' text-red-500';
            registerButton.disabled = false;
            registerButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Create Account';
            return;
        }

        try {
            // --- 1. Create Company ---
            console.log("Creating company...");
            const companyHeaders = new Headers();
            companyHeaders.append("Content-Type", "application/json");

            const companyRaw = JSON.stringify(companyData);

            const createCompanyRequestOptions = {
                method: "POST",
                headers: companyHeaders,
                body: companyRaw,
                redirect: "follow"
            };

            const createCompanyResponse = await fetch('http://localhost:3300/api/cms/companies', createCompanyRequestOptions);
            const companyResult = await createCompanyResponse.json();

            if (!createCompanyResponse.ok) {
                throw new Error(`Company creation failed: ${companyResult.message || `HTTP ${createCompanyResponse.status}`}`);
            }

            console.log("Company created successfully!");

            // --- 2. Get Company ID ---
            console.log("Fetching companies list...");
            const getCompaniesResponse = await fetch("http://localhost:3300/api/cms/companies/", {
                method: "GET",
                redirect: "follow"
            });

            if (!getCompaniesResponse.ok) {
                throw new Error(`Failed to fetch companies: HTTP ${getCompaniesResponse.status}`);
            }
            console.log('PETERRR', getCompaniesResponse);
            const companiesList = await getCompaniesResponse.json();
            console.log("Fetched companies:", companiesList);

            // Find the new company by name
            const newCompany = companiesList.find(c =>
                (c.Name === companyData.Name) ||
                (c.Name && c.Name.Name === companyData.Name)
            );

            console.log("New company found PETERRR 22:", newCompany.Name.CompanyID);
            let companyId;
            if (newCompany && newCompany.Name && newCompany.Name.CompanyID) {
                companyId = parseInt(newCompany.Name.CompanyID, 10); // Parse as integer
            } else if (newCompany && newCompany.CompanyID) {
                companyId = parseInt(newCompany.CompanyID, 10); // Parse as integer
            } else if (companyResult && companyResult.CompanyID) {
                companyId = parseInt(companyResult.CompanyID, 10); // Parse as integer
            } else {
                throw new Error('Company created but CompanyID could not be determined');
            }

            console.log(`Company ID found: ${companyId}`);

            // --- 2. Create Admin User ---
            console.log("Creating admin user...");
            const adminUserHeaders = new Headers();
            adminUserHeaders.append("Content-Type", "application/json");
            adminUserHeaders.append("CompanyID", companyId); // Add CompanyID to header

            const adminUserRaw = JSON.stringify(adminUserData);

            const createAdminUserRequestOptions = {
                method: "POST",
                headers: adminUserHeaders,
                body: adminUserRaw,
                redirect: "follow"
            };

            const createAdminUserResponse = await fetch(`http://localhost:3300/api/cms/company/members/${companyId}`, createAdminUserRequestOptions);
            const adminResult = await createAdminUserResponse.json();

            if (!createAdminUserResponse.ok) {
                throw new Error(`Admin user creation failed: ${adminResult.message || `HTTP ${createAdminUserResponse.status}`}`);
            }

            const GetAdminHeaders = new Headers();
            GetAdminHeaders.append("Content-Type", "application/json");

            const GetAdminraw = JSON.stringify({
                "CompanyID": 1
            });

            const getAdminUserRequest = {
                method: "GET",
                headers: GetAdminHeaders,
                body: GetAdminraw,
                redirect: "follow"
            };

            // Correctly fetch admin user data
            const getAdminUserResponse = await fetch(`http://localhost:3300/api/cms/company/members/${companyId}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
                // Remove body from GET request
                redirect: "follow"
            });

            if (!getAdminUserResponse.ok) {
                throw new Error(`Failed to fetch admin users: HTTP ${getAdminUserResponse.status}`);
            }

            // Parse the JSON response
            const adminUsersList = await getAdminUserResponse.json();
            console.log("Admin users list:", adminUsersList);

            // Find the admin user by email
            let adminMemberId;

            if (Array.isArray(adminUsersList)) {
                // If response is an array, find the matching admin
                const adminUser = adminUsersList.find(user => user.Email === adminUserData.Name.Email);
                if (adminUser) {
                    adminMemberId = adminUser.Name.MemberID;
                }
            } else if (adminUsersList && adminUsersList.Name.Email === adminUserData.Name.Email) {
                // If response is a single object
                adminMemberId = adminUsersList.Name.MemberID;
            }

            if (!adminMemberId) {
                throw new Error('Admin user created, but no MemberID could be determined');
            }
            console.log(`Admin user ID found: ${adminMemberId}`);

            if (!adminMemberId) {
                throw new Error('Admin user created, but no MemberID received.');
            }
            console.log(`Admin user created. ID: ${adminMemberId}`);

            // --- 3. Set Company Admin ---
            console.log("Setting company admin...");
            const setAdminHeaders = new Headers();
            setAdminHeaders.append("Content-Type", "application/json");

            const setAdminRaw = JSON.stringify({AdminID: adminMemberId});

            const setAdminRequestOptions = {
                method: "PUT",
                headers: setAdminHeaders,
                body: setAdminRaw,
                redirect: "follow"
            };

            const setAdminResponse = await fetch(`http://localhost:3300/api/cms/companies/set-admin/${companyId}`, setAdminRequestOptions);
            const setAdminResult = await setAdminResponse.json();

            if (!setAdminResponse.ok) {
                throw new Error(`Setting admin failed: ${setAdminResult.message || `HTTP ${setAdminResponse.status}`}`);
            }
            console.log("Admin user set successfully!");

            // --- Success ---
            messageBox.textContent = 'Company and admin account registered successfully! Redirecting to login...';
            messageBox.className = 'mt-6 text-center text-sm text-green-500';
            setTimeout(() => {
                window.location.href = '../ui/login'; // Adjust path if necessary
            }, 3000);

        } catch (error) {
            console.error('Registration process error:', error);
            messageBox.textContent = `Registration failed: ${error.message}`;
            messageBox.className = 'mt-6 text-center text-sm text-red-500';
        } finally {
            registerButton.disabled = false;
            registerButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Create Account';
        }
    });
</script>
</body>
</html>
